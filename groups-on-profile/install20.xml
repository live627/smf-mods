<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>daniel15:GroupsOnProfile</id>
	<version>1.1.2</version>

	<file name="$sourcedir/Load.php">
		<operation>
			<search position="after"><![CDATA[if (!empty($new_loaded_ids) && $set !== 'minimal')]]></search>
			<add><![CDATA[if (!empty($new_loaded_ids) && $set === 'profile')
		// Get any additional membergroups to show on their profile.
		$user_profile[$new_loaded_ids[0]]['list_additional_groups'] = cache_quick_get('membergroup_list_' . $new_loaded_ids[0], 'Subs-Membergroups.php', 'cache_getMembergroupListForProfile', array($user_profile[$new_loaded_ids[0]]['additional_groups']));

	]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA['local_time' => timeformat(time() + ($profile['time_offset'] - $user_info['time_offset']) * 3600, false),]]></search>
			<add><![CDATA[
		'list_additional_groups' => !empty($profile['list_additional_groups']) ? $profile['list_additional_groups'] : '',]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Membergroups.php">
		<operation>
			<search position="end" />
			<add><![CDATA[
// Retrieve a list of (visible) membergroups used by the cache. (Modified)
function cache_getMembergroupListForProfile($additional_groups)
{
	global $context, $scripturl, $settings, $smcFunc;

	if (!empty($additional_groups))
	{
		$request = $smcFunc['db_query']('', '
			SELECT id_group, group_name, online_color, stars
			FROM {db_prefix}membergroups
			WHERE id_group IN ({array_int:groups})
				AND min_posts = {int:min_posts}
				AND hidden = {int:not_hidden}
				AND id_group != {int:mod_group}
			ORDER BY group_name',
			array(
				'groups' => explode(',', $additional_groups),
				'min_posts' => -1,
				'not_hidden' => 0,
				'mod_group' => 3,
			)
		);
		$groupCache = array();
		while ($row = $smcFunc['db_fetch_assoc']($request))
		{
			$row['stars'] = empty($row['stars']) ? array('', '') : explode('#', $row['stars']);
			$groupCache[] = '<a href="' . $scripturl . '?action=groups;sa=members;group=' . $row['id_group'] . '" style="' . ($row['online_color'] ? 'color: ' . $row['online_color'] . '; ' : '') . ' width: 35%; display: inline-block;">' . $row['group_name'] . '</a> ' . str_repeat('<img src="' . str_replace('$language', $context['user']['language'], isset($row['stars'][1]) ? $settings['images_url'] . '/' . $row['stars'][1] : '') . '" alt="*" style="vertical-align: middle;" />', empty($row['stars'][0]) || empty($row['stars'][1]) ? 0 : $row['stars'][0]);
		}
		$smcFunc['db_free_result']($request);
	}
	else
		$groupCache = array();

	return array(
		'data' => $groupCache,
		'expires' => time() + 3600,
		'refresh_eval' => 'return $GLOBALS[\'modSettings\'][\'settings_updated\'] > ' . time() . ';',
	);
}

]]></add>
		</operation>
	</file>

	<file name="$themedir/Profile.template.php">
		<operation>
			<search position="before"><![CDATA[<dd>', $context['member']['username'], '</dd>';]]></search>
			<add><![CDATA[

	// If they are assigned to additional membergroups, show them.
	$x = 1;
	if (!empty($context['member']['list_additional_groups']))
		foreach ($context['member']['list_additional_groups'] as $list_additional_group)
		{
			echo '
					<dt>', $txt['position'], ': </dt>
					<dd>', $list_additional_group, '</dd>';

			$x++;
		}
]]></add>
		</operation>
	</file>

	<file name="$themedir/UltimateProfile.template.php" error="skip">
		<operation>
			<search position="before"><![CDATA[<dd>', $context['member']['name'], '</dd>';]]></search>
			<add><![CDATA[

	// If they are assigned to additional membergroups, show them.
	$x = 1;
	if (!empty($context['member']['list_additional_groups']))
		foreach ($context['member']['list_additional_groups'] as $list_additional_group)
		{
			echo '
					<dt>', $txt['position'], ' ', $x, ': </dt>
					<dd>', $list_additional_group, '</dd>';

			$x++;
		}
]]></add>
		</operation>
	</file>
</modification>
